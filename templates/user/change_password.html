{% extends "base.html" %}

{% block title %}Change Password - Mailroom Tracking{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto space-y-6">
    <!-- Page Header -->
    <div>
        <h1 class="text-3xl font-bold">Change Password</h1>
        <p class="text-base-content/70 mt-1">Update your account password</p>
    </div>

    <!-- Password Change Form -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            {% if user.must_change_password %}
            <div role="alert" class="alert alert-warning mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                <span><strong>Action Required:</strong> You must change your password before continuing.</span>
            </div>
            {% endif %}

            <!-- Error Display -->
            <div id="error-message" class="hidden mb-4">
                <div role="alert" class="alert alert-error">
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="error-text"></span>
                </div>
            </div>

            <form method="POST" action="/me/password" class="space-y-4" id="password-form">
                {{ csrf_input()|safe }}
                <!-- Current Password -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Current Password <span class="text-error">*</span></span>
                    </label>
                    <input 
                        type="password" 
                        name="current_password" 
                        placeholder="Enter current password" 
                        class="input input-bordered" 
                        required
                        autocomplete="current-password"
                    />
                </div>

                <!-- New Password -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">New Password <span class="text-error">*</span></span>
                    </label>
                    <input 
                        type="password" 
                        name="new_password" 
                        placeholder="Enter new password" 
                        class="input input-bordered" 
                        required 
                        minlength="12"
                        id="new-password"
                        autocomplete="new-password"
                    />
                </div>

                <!-- Confirm Password -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Confirm New Password <span class="text-error">*</span></span>
                    </label>
                    <input 
                        type="password" 
                        name="confirm_password" 
                        placeholder="Confirm new password" 
                        class="input input-bordered" 
                        required 
                        minlength="12"
                        id="confirm-password"
                        autocomplete="new-password"
                    />
                    <label class="label">
                        <span class="label-text-alt" id="password-match-message"></span>
                    </label>
                </div>

                <!-- Password Requirements -->
                <div role="alert" class="alert alert-info">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <div>
                        <h3 class="font-bold">Password Requirements:</h3>
                        <ul class="list-disc list-inside text-sm mt-1" id="password-requirements">
                            <li id="req-length">At least 12 characters long</li>
                            <li id="req-upper">Contains uppercase letter (A-Z)</li>
                            <li id="req-lower">Contains lowercase letter (a-z)</li>
                            <li id="req-digit">Contains digit (0-9)</li>
                            <li id="req-special">Contains special character (!@#$%^&*)</li>
                        </ul>
                        <p class="text-sm mt-2">Your password cannot be one of your last 3 passwords.</p>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex gap-2 justify-end pt-4">
                    {% if not user.must_change_password %}
                    <a href="/dashboard" class="btn btn-ghost">Cancel</a>
                    {% endif %}
                    <button type="submit" class="btn btn-primary" id="submit-btn">Change Password</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Security Tips -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h3 class="card-title">Password Security Tips</h3>
            <ul class="list-disc list-inside space-y-2 text-sm">
                <li>Use a unique password that you don't use for other accounts</li>
                <li>Consider using a passphrase made of multiple words</li>
                <li>Avoid using personal information like names or birthdays</li>
                <li>Don't share your password with anyone</li>
                <li>Change your password if you suspect it has been compromised</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const newPasswordInput = document.getElementById('new-password');
const confirmPasswordInput = document.getElementById('confirm-password');
const matchMessage = document.getElementById('password-match-message');
const submitBtn = document.getElementById('submit-btn');

// Password strength validation
newPasswordInput.addEventListener('input', function(e) {
    const password = e.target.value;
    
    // Check requirements
    const hasLength = password.length >= 12;
    const hasUpper = /[A-Z]/.test(password);
    const hasLower = /[a-z]/.test(password);
    const hasDigit = /\d/.test(password);
    const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
    
    // Update UI
    updateRequirement('req-length', hasLength);
    updateRequirement('req-upper', hasUpper);
    updateRequirement('req-lower', hasLower);
    updateRequirement('req-digit', hasDigit);
    updateRequirement('req-special', hasSpecial);
    
    // Check password match
    checkPasswordMatch();
});

// Password match validation
confirmPasswordInput.addEventListener('input', checkPasswordMatch);

function updateRequirement(id, met) {
    const element = document.getElementById(id);
    if (met) {
        element.classList.add('text-success');
        element.classList.remove('text-base-content');
    } else {
        element.classList.remove('text-success');
        element.classList.add('text-base-content');
    }
}

function checkPasswordMatch() {
    const newPassword = newPasswordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    
    if (confirmPassword.length === 0) {
        matchMessage.textContent = '';
        matchMessage.className = 'label-text-alt';
        return;
    }
    
    if (newPassword === confirmPassword) {
        matchMessage.textContent = '✓ Passwords match';
        matchMessage.className = 'label-text-alt text-success';
    } else {
        matchMessage.textContent = '✗ Passwords do not match';
        matchMessage.className = 'label-text-alt text-error';
    }
}

// Form submission with error handling
document.getElementById('password-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const newPassword = newPasswordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    
    if (newPassword !== confirmPassword) {
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        errorText.textContent = 'Passwords do not match. Please check and try again.';
        errorDiv.classList.remove('hidden');
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return false;
    }
    
    const form = e.target;
    const formData = new FormData(form);
    const errorDiv = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const submitBtn = document.getElementById('submit-btn');
    
    errorDiv.classList.add('hidden');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="loading loading-spinner"></span> Changing...';
    
    try {
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData,
            redirect: 'manual'
        });
        
        if (response.type === 'opaqueredirect' || (response.status >= 300 && response.status < 400)) {
            window.location.href = '/dashboard';
        } else if (response.ok) {
            window.location.href = '/dashboard';
        } else if (!response.ok) {
            const data = await response.json();
            errorText.textContent = data.detail || 'Failed to change password';
            errorDiv.classList.remove('hidden');
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Change Password';
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    } catch (error) {
        errorText.textContent = 'An unexpected error occurred. Please try again.';
        errorDiv.classList.remove('hidden');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Change Password';
    }
});
</script>
{% endblock %}
