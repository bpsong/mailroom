{% extends "base.html" %}

{% block title %}Active Sessions - Mailroom Tracking{% endblock %}

{% block content %}
<div class="container mx-auto max-w-5xl">
    <!-- Page Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-3xl font-bold">üîê Active Sessions</h1>
            <p class="text-base-content/70 mt-1">Manage your active login sessions</p>
        </div>
        <a href="/me/profile" class="btn btn-ghost">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Back to Profile
        </a>
    </div>

    <!-- Session Limit Info -->
    <div role="alert" class="alert alert-info mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div>
            <h3 class="font-bold">Session Management</h3>
            <div class="text-sm">
                You have <strong>{{ sessions|length }}</strong> active session(s). Maximum allowed: <strong>3</strong> concurrent sessions.
                Sessions automatically expire after 30 minutes of inactivity.
            </div>
        </div>
    </div>

    <!-- Sessions List -->
    {% if sessions %}
    <div class="space-y-4">
        {% for session in sessions %}
        <div class="card bg-base-100 shadow-xl {% if loop.first %}border-2 border-info{% endif %}">
            <div class="card-body">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                    <!-- Session Info -->
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-3">
                            {% if loop.first %}
                            <div class="badge badge-info badge-lg">Current Session</div>
                            {% else %}
                            <div class="badge badge-ghost badge-lg">Other Device</div>
                            {% endif %}
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- IP Address -->
                            <div>
                                <div class="flex items-center gap-2 text-sm font-semibold mb-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                                    </svg>
                                    IP Address
                                </div>
                                <div class="font-mono text-sm">{{ session.ip_address or 'Unknown' }}</div>
                            </div>
                            
                            <!-- User Agent -->
                            <div>
                                <div class="flex items-center gap-2 text-sm font-semibold mb-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                    </svg>
                                    Device / Browser
                                </div>
                                <div class="text-sm truncate" title="{{ session.user_agent or 'Unknown' }}">
                                    {{ session.user_agent[:50] if session.user_agent else 'Unknown' }}
                                    {% if session.user_agent and session.user_agent|length > 50 %}...{% endif %}
                                </div>
                            </div>
                            
                            <!-- Created At -->
                            <div>
                                <div class="flex items-center gap-2 text-sm font-semibold mb-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    Login Time
                                </div>
                                <div class="text-sm">{{ session.created_at.strftime('%B %d, %Y at %I:%M %p') }}</div>
                            </div>
                            
                            <!-- Last Activity -->
                            <div>
                                <div class="flex items-center gap-2 text-sm font-semibold mb-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                    </svg>
                                    Last Activity
                                </div>
                                <div class="text-sm">{{ session.last_activity.strftime('%B %d, %Y at %I:%M %p') }}</div>
                            </div>
                            
                            <!-- Expires At -->
                            <div class="md:col-span-2">
                                <div class="flex items-center gap-2 text-sm font-semibold mb-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    Expires
                                </div>
                                <div class="text-sm">{{ session.expires_at.strftime('%B %d, %Y at %I:%M %p') }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    {% if not loop.first %}
                    <div class="flex-shrink-0">
                        <button 
                            class="btn btn-error btn-sm"
                            onclick="confirmTerminate('{{ session.id }}', '{{ session.ip_address if session.ip_address else 'Unknown' }}')"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                            Terminate
                        </button>
                    </div>
                    {% else %}
                    <div class="flex-shrink-0">
                        <div class="tooltip" data-tip="Cannot terminate current session">
                            <button class="btn btn-disabled btn-sm">
                                Current Session
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- No Sessions -->
    <div role="alert" class="alert">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-info shrink-0 w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>No active sessions found.</span>
    </div>
    {% endif %}

    <!-- Security Warning -->
    <div role="alert" class="alert alert-warning mt-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <div>
            <h3 class="font-bold">Security Notice</h3>
            <div class="text-sm">
                If you see any sessions you don't recognize, terminate them immediately and change your password.
                Contact your administrator if you suspect unauthorized access.
            </div>
        </div>
    </div>
</div>

<!-- Terminate Confirmation Modal -->
<dialog id="terminate-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Terminate Session</h3>
        <div class="py-4">
            <div role="alert" class="alert alert-warning">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <span>Are you sure you want to terminate the session from IP: <strong id="terminate-ip"></strong>?</span>
            </div>
            <p class="mt-2 text-sm">This will immediately log out that device. This action cannot be undone.</p>
        </div>
        <div class="modal-action">
            <button type="button" class="btn" onclick="document.getElementById('terminate-modal').close()">Cancel</button>
            <form id="terminate-form" method="POST" style="display: inline;">
                {{ csrf_input(request)|safe }}
                <button type="submit" class="btn btn-error">Terminate Session</button>
            </form>
        </div>
    </div>
</dialog>
{% endblock %}

{% block extra_scripts %}
<script>
function confirmTerminate(sessionId, ipAddress) {
    document.getElementById('terminate-ip').textContent = ipAddress;
    document.getElementById('terminate-form').action = `/me/sessions/${sessionId}/terminate`;
    document.getElementById('terminate-modal').showModal();
}
</script>
{% endblock %}
