<!-- Mobile-optimized photo upload modal with camera capture -->
<dialog id="photo_upload_modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box w-full max-w-full sm:max-w-lg">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
        </form>
        
        <h3 class="font-bold text-lg mb-4">ðŸ“· Add Package Photo</h3>
        
        <form 
            method="POST" 
            action="/packages/{{ package_id }}/photo"
            enctype="multipart/form-data"
            hx-post="/packages/{{ package_id }}/photo"
            hx-encoding="multipart/form-data"
            hx-target="#photo-result"
            hx-indicator="#photo-loading"
            class="space-y-4"
        >
            {{ csrf_input()|safe }}
            <!-- Photo upload with camera capture -->
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text font-semibold">Select or Capture Photo</span>
                    <span class="label-text-alt text-error">Required</span>
                </label>
                
                <!-- File input with camera capture for mobile -->
                <input 
                    type="file" 
                    name="photo" 
                    id="photo-input"
                    accept="image/jpeg,image/png,image/webp" 
                    capture="environment"
                    class="file-input file-input-bordered file-input-lg w-full" 
                    required
                    onchange="previewPhoto(event)"
                />
                
                <label class="label">
                    <span class="label-text-alt">Max 5MB â€¢ JPEG, PNG, WebP</span>
                </label>
            </div>
            
            <!-- Photo preview -->
            <div id="photo-preview" class="hidden">
                <div class="card bg-base-200">
                    <figure class="px-4 pt-4">
                        <img 
                            id="preview-image" 
                            src="" 
                            alt="Photo preview"
                            class="rounded-xl max-h-64 w-auto object-contain"
                        />
                    </figure>
                    <div class="card-body p-4">
                        <button 
                            type="button" 
                            class="btn btn-sm btn-ghost"
                            onclick="clearPhotoPreview()"
                        >
                            âœ• Clear
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Loading indicator -->
            <div id="photo-loading" class="htmx-indicator">
                <div class="flex items-center justify-center gap-2 py-4">
                    <span class="loading loading-spinner loading-md"></span>
                    <span>Uploading photo...</span>
                </div>
            </div>
            
            <!-- Result container -->
            <div id="photo-result"></div>
            
            <!-- Action buttons -->
            <div class="modal-action">
                <button type="button" class="btn btn-ghost min-h-touch" onclick="photo_upload_modal.close()">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary min-h-touch">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Upload Photo
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
    // Preview photo before upload
    function previewPhoto(event) {
        const file = event.target.files[0];
        if (file) {
            // Check file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                showToast('File size must be less than 5MB', 'error');
                event.target.value = '';
                return;
            }
            
            // Check file type
            const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                showToast('Please select a valid image file (JPEG, PNG, or WebP)', 'error');
                event.target.value = '';
                return;
            }
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview-image').src = e.target.result;
                document.getElementById('photo-preview').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    }
    
    // Clear photo preview
    function clearPhotoPreview() {
        document.getElementById('photo-input').value = '';
        document.getElementById('photo-preview').classList.add('hidden');
        document.getElementById('preview-image').src = '';
    }
    
    // Handle successful photo upload
    document.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'photo-result') {
            if (event.detail.xhr.status === 200) {
                showToast('Photo uploaded successfully!', 'success');
                setTimeout(() => {
                    photo_upload_modal.close();
                    clearPhotoPreview();
                    window.location.reload();
                }, 1500);
            }
        }
    });
    
    // Clear preview when modal closes
    document.getElementById('photo_upload_modal')?.addEventListener('close', function() {
        clearPhotoPreview();
    });
</script>
