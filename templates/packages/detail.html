{% extends "base.html" %}

{% block title %}Package {{ package.tracking_no }} - Mailroom Tracking{% endblock %}

{% block content %}
<div class="container mx-auto max-w-5xl">
    <div class="mb-6">
        <a href="/packages" class="btn btn-ghost btn-sm">
            ‚Üê Back to Packages
        </a>
    </div>

    <!-- Package Information Card -->
    <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
            <div class="flex justify-between items-start">
                <h2 class="card-title text-2xl">üì¶ {{ package.tracking_no }}</h2>
                {% if package.status == 'registered' %}
                <span class="badge badge-neutral badge-lg">Registered</span>
                {% elif package.status == 'awaiting_pickup' %}
                <span class="badge badge-warning badge-lg">Awaiting Pickup</span>
                {% elif package.status == 'out_for_delivery' %}
                <span class="badge badge-info badge-lg">Out for Delivery</span>
                {% elif package.status == 'delivered' %}
                <span class="badge badge-success badge-lg">Delivered</span>
                {% elif package.status == 'returned' %}
                <span class="badge badge-error badge-lg">Returned</span>
                {% endif %}
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div>
                    <p class="text-sm text-base-content/70">Carrier</p>
                    <p class="font-semibold">{{ package.carrier }}</p>
                </div>
                <div>
                    <p class="text-sm text-base-content/70">Recipient</p>
                    <p class="font-semibold">{{ package.recipient_name }}</p>
                    <p class="text-sm">{{ package.recipient_email }}</p>
                    {% if package.recipient_department %}
                    <p class="text-sm text-base-content/70">{{ package.recipient_department }}</p>
                    {% endif %}
                </div>
                <div>
                    <p class="text-sm text-base-content/70">Registered By</p>
                    <p class="font-semibold">{{ package.created_by_name }}</p>
                    <p class="text-sm">{{ package.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                </div>
                <div>
                    <p class="text-sm text-base-content/70">Last Updated</p>
                    <p class="font-semibold">{{ package.updated_at.strftime('%Y-%m-%d %H:%M') }}</p>
                </div>
            </div>

            {% if package.notes %}
            <div class="mt-4">
                <p class="text-sm text-base-content/70">Notes</p>
                <p class="mt-1">{{ package.notes }}</p>
            </div>
            {% endif %}

            <!-- Update Status Button -->
            {% if package.status not in ['delivered', 'returned'] %}
            <div class="card-actions justify-end mt-4">
                <button 
                    class="btn btn-primary"
                    onclick="status_modal.showModal()"
                >
                    Update Status
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- QR Code Card -->
    <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
            <h2 class="card-title">üî≤ QR Code</h2>
            <div class="flex flex-col items-center gap-4">
                <img 
                    src="data:image/png;base64,{{ qr_code_data }}" 
                    alt="Package QR Code"
                    class="w-48 h-48 border-2 border-base-300 rounded"
                />
                <div class="flex gap-2 flex-wrap justify-center">
                    <a 
                        href="/packages/{{ package.id }}/qrcode/download" 
                        class="btn btn-primary"
                    >
                        üì• Download PNG
                    </a>
                    <a 
                        href="/packages/{{ package.id }}/qrcode/print" 
                        target="_blank"
                        class="btn btn-secondary"
                    >
                        üñ®Ô∏è Print Sticker
                    </a>
                </div>
                <p class="text-sm text-base-content/60 text-center">
                    Scan with mobile device for quick access
                </p>
            </div>
        </div>
    </div>

    <!-- Status Timeline -->
    <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
            <h3 class="card-title">üìã Status History</h3>
            
            <ul class="steps steps-vertical w-full mt-4">
                {% for event in package.timeline %}
                <li class="step step-primary">
                    <div class="text-left w-full">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold">
                                    {% if event.new_status == 'registered' %}
                                    üì¶ Registered
                                    {% elif event.new_status == 'awaiting_pickup' %}
                                    ‚è≥ Awaiting Pickup
                                    {% elif event.new_status == 'out_for_delivery' %}
                                    üöö Out for Delivery
                                    {% elif event.new_status == 'delivered' %}
                                    ‚úÖ Delivered
                                    {% elif event.new_status == 'returned' %}
                                    ‚Ü©Ô∏è Returned
                                    {% endif %}
                                </p>
                                {% if event.notes %}
                                <p class="text-sm text-base-content/70 mt-1">{{ event.notes }}</p>
                                {% endif %}
                            </div>
                            <div class="text-right text-sm text-base-content/70">
                                {{ event.created_at.strftime('%Y-%m-%d %H:%M') }}
                            </div>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Attachments -->
    {% if attachments %}
    <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
            <h3 class="card-title">üì∑ Photos</h3>
            
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mt-4">
                {% for attachment in attachments %}
                <div class="card bg-base-200">
                    <figure class="px-4 pt-4">
                        <img 
                            src="/uploads/{{ attachment.file_path }}" 
                            alt="{{ attachment.filename }}"
                            class="rounded-xl w-full h-32 object-cover"
                        />
                    </figure>
                    <div class="card-body p-4">
                        <p class="text-xs text-base-content/70">
                            {{ attachment.created_at.strftime('%Y-%m-%d %H:%M') }}
                        </p>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Add Photo Button -->
            <div class="card-actions justify-end mt-4">
                <button 
                    class="btn btn-outline btn-sm"
                    onclick="photo_modal.showModal()"
                >
                    üì∑ Add Photo
                </button>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Status Update Modal -->
<dialog id="status_modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Update Package Status</h3>
        <form 
            method="POST" 
            action="/packages/{{ package.id }}/status"
            hx-post="/packages/{{ package.id }}/status"
            hx-target="#status-result"
            class="mt-4"
        >
            {{ csrf_input()|safe }}
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text">New Status</span>
                </label>
                <select name="status" class="select select-bordered w-full" required>
                    {% if package.status == 'registered' %}
                    <option value="awaiting_pickup">Awaiting Pickup</option>
                    <option value="out_for_delivery">Out for Delivery</option>
                    <option value="delivered">Delivered</option>
                    <option value="returned">Returned</option>
                    {% elif package.status == 'awaiting_pickup' %}
                    <option value="out_for_delivery">Out for Delivery</option>
                    <option value="delivered">Delivered</option>
                    <option value="returned">Returned</option>
                    {% elif package.status == 'out_for_delivery' %}
                    <option value="delivered">Delivered</option>
                    <option value="returned">Returned</option>
                    {% endif %}
                </select>
            </div>

            <div class="form-control w-full mt-4">
                <label class="label">
                    <span class="label-text">Notes (Optional)</span>
                </label>
                <textarea 
                    name="notes" 
                    placeholder="Add notes about this status change" 
                    class="textarea textarea-bordered h-24"
                    maxlength="500"
                ></textarea>
                <label class="label">
                    <span class="label-text-alt text-base-content/70">Max 500 characters</span>
                </label>
            </div>

            <div id="status-result" class="mt-4"></div>

            <div class="modal-action">
                <button type="button" class="btn" onclick="status_modal.close()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Status</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Add Photo Modal -->
<dialog id="photo_modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Add Photo</h3>
        <form 
            method="POST" 
            action="/packages/{{ package.id }}/photo"
            enctype="multipart/form-data"
            hx-post="/packages/{{ package.id }}/photo"
            hx-encoding="multipart/form-data"
            hx-target="#photo-result"
            class="mt-4"
        >
            {{ csrf_input()|safe }}
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text">Photo</span>
                </label>
                <input 
                    type="file" 
                    name="photo" 
                    id="detail-photo-upload"
                    accept="image/*" 
                    capture="environment"
                    class="file-input file-input-bordered w-full" 
                    required
                />
                <label class="label">
                    <span class="label-text-alt" id="detail-photo-size-info">Max 5MB. Formats: JPEG, PNG, WebP</span>
                </label>
            </div>

            <div id="photo-result" class="mt-4"></div>

            <div class="modal-action">
                <button type="button" class="btn" onclick="photo_modal.close()">Cancel</button>
                <button type="submit" class="btn btn-primary">Upload Photo</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>
{% endblock %}

{% block extra_scripts %}
<script>
    // Close modal and reload page on successful status update
    document.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'status-result' && event.detail.successful) {
            setTimeout(() => {
                status_modal.close();
                window.location.reload();
            }, 1500);
        }
        if (event.detail.target.id === 'photo-result' && event.detail.successful) {
            setTimeout(() => {
                photo_modal.close();
                window.location.reload();
            }, 1500);
        }
    });

    // File size validation for photo upload
    document.getElementById('detail-photo-upload')?.addEventListener('change', function(e) {
        const file = e.target.files[0];
        const sizeInfo = document.getElementById('detail-photo-size-info');
        
        if (file) {
            const maxSize = 5 * 1024 * 1024; // 5MB in bytes
            
            if (file.size > maxSize) {
                sizeInfo.textContent = `File too large (${(file.size / 1024 / 1024).toFixed(2)}MB). Max 5MB.`;
                sizeInfo.className = 'label-text-alt text-error';
                this.value = ''; // Clear the file input
                alert('Photo file size must be less than 5MB. Please select a smaller file.');
            } else {
                sizeInfo.textContent = `Selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`;
                sizeInfo.className = 'label-text-alt text-success';
            }
        } else {
            sizeInfo.textContent = 'Max 5MB. Formats: JPEG, PNG, WebP';
            sizeInfo.className = 'label-text-alt';
        }
    });
</script>
{% endblock %}
