{% extends "base.html" %}

{% block title %}Audit Logs - Mailroom Tracking{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold">Audit Logs</h1>
            <p class="text-base-content/70 mt-1">View system activity and authentication events</p>
        </div>
        <div class="badge badge-error badge-lg">Super Admin Only</div>
    </div>

    <!-- Search and Filters -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <form hx-get="/admin/audit-logs" hx-target="#audit-logs-table" hx-trigger="submit, change delay:300ms" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Username</span>
                    </label>
                <input type="text" name="username" placeholder="Search username..." class="input input-bordered" value="{{ filters.username or '' }}" maxlength="50" />
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Event Type</span>
                    </label>
                    <select name="event_type" class="select select-bordered">
                        <option value="">All Events</option>
                        {% for event in event_types %}
                        <option value="{{ event }}" {% if filters.event_type == event %}selected{% endif %}>{{ event.replace('_', ' ').title() }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Start Date</span>
                    </label>
                    <input type="date" name="start_date" class="input input-bordered" value="{{ filters.start_date or '' }}" />
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">End Date</span>
                    </label>
                    <input type="date" name="end_date" class="input input-bordered" value="{{ filters.end_date or '' }}" />
                </div>
                
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">&nbsp;</span>
                    </label>
                    <button type="submit" class="btn btn-primary">Search</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Audit Logs Table -->
    <div id="audit-logs-table" class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex items-center justify-between mb-4">
                <h2 class="card-title">Audit Events</h2>
                <div class="text-sm text-base-content/70">
                    Total: {{ pagination.total }} events
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="table table-zebra">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Event Type</th>
                            <th>User</th>
                            <th>Username</th>
                            <th>IP Address</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for event in events %}
                        <tr>
                            <td>
                                <div class="text-sm">{{ event.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</div>
                            </td>
                            <td>
                                {% if event.event_type == 'login' %}
                                <span class="badge badge-success">Login</span>
                                {% elif event.event_type == 'login_failed' %}
                                <span class="badge badge-error">Login Failed</span>
                                {% elif event.event_type == 'logout' %}
                                <span class="badge badge-info">Logout</span>
                                {% elif event.event_type == 'password_changed' %}
                                <span class="badge badge-warning">Password Changed</span>
                                {% elif event.event_type == 'password_reset' %}
                                <span class="badge badge-warning">Password Reset</span>
                                {% elif event.event_type == 'user_management' %}
                                <span class="badge badge-primary">User Management</span>
                                {% elif event.event_type == 'recipient_import' %}
                                <span class="badge badge-secondary">Recipient Import</span>
                                {% else %}
                                <span class="badge badge-ghost">{{ event.event_type }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if event.user_full_name %}
                                <div class="font-medium">{{ event.user_full_name }}</div>
                                {% if event.user_role %}
                                <div class="text-xs text-base-content/70">{{ event.user_role }}</div>
                                {% endif %}
                                {% else %}
                                <span class="text-base-content/50">—</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if event.username %}
                                <code class="text-sm">{{ event.username }}</code>
                                {% else %}
                                <span class="text-base-content/50">—</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if event.ip_address %}
                                <code class="text-sm">{{ event.ip_address }}</code>
                                {% else %}
                                <span class="text-base-content/50">—</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if event.details %}
                                <button class="btn btn-ghost btn-xs" onclick="showDetails('{{ event.id }}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    View
                                </button>
                                <div id="details-{{ event.id }}" class="hidden">
                                    <pre class="text-xs bg-base-200 p-2 rounded mt-2 overflow-x-auto">{{ event.details | tojson(indent=2) }}</pre>
                                </div>
                                {% else %}
                                <span class="text-base-content/50">—</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            {% if pagination.total > pagination.limit %}
            <div class="flex justify-center mt-4">
                <div class="join">
                    {% if pagination.offset > 0 %}
                    <button class="join-item btn" 
                            hx-get="/admin/audit-logs?offset={{ pagination.offset - pagination.limit }}&limit={{ pagination.limit }}{% if filters.username %}&username={{ filters.username }}{% endif %}{% if filters.event_type %}&event_type={{ filters.event_type }}{% endif %}{% if filters.start_date %}&start_date={{ filters.start_date }}{% endif %}{% if filters.end_date %}&end_date={{ filters.end_date }}{% endif %}" 
                            hx-target="#audit-logs-table">
                        «
                    </button>
                    {% endif %}
                    
                    <button class="join-item btn btn-active">
                        Page {{ pagination.current_page }} of {{ pagination.total_pages }}
                    </button>
                    
                    {% if pagination.has_more %}
                    <button class="join-item btn" 
                            hx-get="/admin/audit-logs?offset={{ pagination.offset + pagination.limit }}&limit={{ pagination.limit }}{% if filters.username %}&username={{ filters.username }}{% endif %}{% if filters.event_type %}&event_type={{ filters.event_type }}{% endif %}{% if filters.start_date %}&start_date={{ filters.start_date }}{% endif %}{% if filters.end_date %}&end_date={{ filters.end_date }}{% endif %}" 
                            hx-target="#audit-logs-table">
                        »
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function showDetails(eventId) {
    const detailsDiv = document.getElementById('details-' + eventId);
    if (detailsDiv) {
        detailsDiv.classList.toggle('hidden');
    }
}
</script>
{% endblock %}
